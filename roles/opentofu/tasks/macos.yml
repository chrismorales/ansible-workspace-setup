---
- name: Check if OpenTofu is already installed
  command: tofu --version
  register: tofu_check
  failed_when: false
  changed_when: false

- name: Install OpenTofu using official installer (macOS)
  block:
    - name: Download OpenTofu installer script
      get_url:
        url: https://get.opentofu.org/install-opentofu.sh
        dest: /tmp/install-opentofu.sh
        mode: '0755'
        force: yes

    - name: Run OpenTofu installer (brew method if available, otherwise standalone)
      shell: |
        if command -v brew >/dev/null 2>&1; then
          /tmp/install-opentofu.sh --install-method brew
        else
          /tmp/install-opentofu.sh --install-method standalone
        fi
      args:
        creates: /usr/local/bin/tofu

    - name: Remove installer script
      file:
        path: /tmp/install-opentofu.sh
        state: absent
  when: tofu_check.rc != 0

- name: Ensure OpenTofu binary is executable
  file:
    path: /usr/local/bin/tofu
    mode: '0755'